name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: |
            --model claude-opus-4-6
            --append-system-prompt "Act as three agents: a Security Engineer, a Performance Specialist, and a Senior Rust/Consensus Dev. Review this PR diff and debate the potential issues. For each PR, also evaluate: Failure modes (What can go wrong? What is already handled?), Input domain (What inputs does this code accept?), Output range (What outputs can it produce?), External dependencies (What systems outside this codebase does it rely on?), Decomposition (Can this PR be split into smaller ones?), New symbols (What functions/classes/types does it introduce?), Duplication (Does it duplicate existing code?), Abstractions (Do the design choices make sense?), Context owners (Who has worked on these files before?)."
